"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var nativescript_background_http_1 = require("nativescript-background-http");
var Picker = require("nativescript-imagepicker");
var camera = require("nativescript-camera");
var lodash_1 = require("lodash");
var Subject_1 = require("rxjs/Subject");
var platform_1 = require("tns-core-modules/platform");
var fs = require("file-system");
var imageSource = require("image-source");
var ItemsComponent = (function () {
    function ItemsComponent() {
        this.UploadSession = nativescript_background_http_1.session('image-upload');
    }
    ItemsComponent.prototype.ngOnInit = function () {
    };
    ItemsComponent.prototype.cameraOpen = function () {
        var _this = this;
        camera.requestPermissions();
        camera
            .takePicture({
            saveToGallery: true,
            cameraFacing: 'front'
        })
            .then(function (imageAsset) {
            var image;
            if (platform_1.isAndroid) {
                image = {
                    fileUri: imageAsset.android
                };
                _this.uploadImagePicker(image);
            }
            else {
                var source = new imageSource.ImageSource();
                source.fromAsset(imageAsset)
                    .then(function (imageSource) {
                    var folder = fs.knownFolders.documents();
                    var path = fs.path.join(folder.path, "Temp" + Date.now() + ".jpg");
                    var saved = imageSource.saveToFile(path, "png");
                    console.log(saved);
                    if (saved) {
                        _this.uploadImagePicker({ fileUri: path });
                    }
                });
            }
        })
            .catch(function (err) {
            console.log("Error -> " + err.message);
        });
    };
    ItemsComponent.prototype.pickerOpen = function () {
        var context = Picker.create({
            mode: "single",
            mdeiaType: 'image'
        });
        this.startSelection(context);
    };
    ItemsComponent.prototype.startSelection = function (context) {
        var _this = this;
        context
            .authorize()
            .then(function () {
            return context.present();
        })
            .then(function (selection) {
            if (platform_1.isAndroid) {
                return lodash_1.first(selection);
            }
            else {
                return lodash_1.first(selection).getImage();
            }
        })
            .then(function (image) {
            if (platform_1.isAndroid) {
                _this.uploadImagePicker(image);
            }
            else {
                var folder = fs.knownFolders.documents();
                var path = fs.path.join(folder.path, "Temp" + Date.now() + ".png");
                var saved = image.saveToFile(path, "png");
                console.log(saved);
                if (saved) {
                    //use new image path
                    _this.uploadImagePicker({ fileUri: path });
                }
            }
        })
            .catch(function (e) {
            console.error(e);
        });
    };
    ItemsComponent.prototype.uploadImagePicker = function (image) {
        this.uploadMultipartImagePicker(image)
            .subscribe({
            next: function (e) {
                console.log("Upload: " + (e.currentBytes / e.totalBytes) * 100);
            },
            error: function (e) {
                console.log(JSON.stringify(e));
            },
            complete: function () {
                console.log("complete");
            }
        });
    };
    ItemsComponent.prototype.uploadMultipartImagePicker = function (image) {
        var fileUri = image.fileUri;
        var request = {
            url: "http://35.158.193.55/api/FileUpload/BolSelfie",
            method: 'POST',
            headers: {
                "Content-Type": "application/octet-stream",
                "File-Name": fileUri,
                'Authorization': "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJuYW1laWQiOiI4MzlmMDg4NC1jMmI3LTQ1ZGUtOTc1Yy0wOTYwMTY4MWE2M2EiLCJ1bmlxdWVfbmFtZSI6IjgzOWYwODg0LWMyYjctNDVkZS05NzVjLTA5NjAxNjgxYTYzYSIsImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vYWNjZXNzY29udHJvbHNlcnZpY2UvMjAxMC8wNy9jbGFpbXMvaWRlbnRpdHlwcm92aWRlciI6IkFTUC5ORVQgSWRlbnRpdHkiLCJBc3BOZXQuSWRlbnRpdHkuU2VjdXJpdHlTdGFtcCI6ImFiNGNmOWE2LWVmYzEtNDZhNi05N2YyLWNlNzc5NjkxZGMxMCIsIlVzZXJJZCI6IjgzOWYwODg0LWMyYjctNDVkZS05NzVjLTA5NjAxNjgxYTYzYSIsImlzcyI6Imh0dHA6Ly9sb2NhbGhvc3QiLCJhdWQiOiI0MTRlMTkyN2EzODg0ZjY4YWJjNzlmNzI4MzgzN2ZkMSIsImV4cCI6MTU2MzgxMDQ4NiwibmJmIjoxNTExOTcwNDg2fQ.KUdYperMo_79QhR3sU3odmt7LzuCjdSMa25-AU9QLwA",
                "UserId": "2a2736cb-e5e6-4515-8ad7-02ea0cfef08b"
            },
            description: "Uploading "
        };
        var params = [{ name: "nameOfFile", filename: fileUri, mimeType: 'image/JPG' }];
        console.log(JSON.stringify(params));
        var subject = new Subject_1.Subject();
        var task = this.UploadSession.multipartUpload(params, request);
        task.on('progress', function (e) { return subject.next(e); });
        task.on('error', function (e) { return subject.error(e); });
        task.on('complete', function (e) { return subject.complete(); });
        return subject;
    };
    ItemsComponent = __decorate([
        core_1.Component({
            selector: "ns-items",
            moduleId: module.id,
            templateUrl: "./items.component.html",
        }),
        __metadata("design:paramtypes", [])
    ], ItemsComponent);
    return ItemsComponent;
}());
exports.ItemsComponent = ItemsComponent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaXRlbXMuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiaXRlbXMuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsc0NBQWtEO0FBRWxELDZFQUFnRTtBQUNoRSxpREFBbUQ7QUFDbkQsNENBQThDO0FBQzlDLGlDQUErQjtBQUMvQix3Q0FBcUM7QUFDckMsc0RBQW9EO0FBQ3BELGdDQUFrQztBQUNsQywwQ0FBNEM7QUFRNUM7SUFLSTtRQUdJLElBQUksQ0FBQyxhQUFhLEdBQUcsc0NBQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUNqRCxDQUFDO0lBRUQsaUNBQVEsR0FBUjtJQUNBLENBQUM7SUFFRCxtQ0FBVSxHQUFWO1FBQUEsaUJBaUNDO1FBaENHLE1BQU0sQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO1FBQzVCLE1BQU07YUFDRCxXQUFXLENBQUM7WUFDVCxhQUFhLEVBQUUsSUFBSTtZQUNuQixZQUFZLEVBQUUsT0FBTztTQUN4QixDQUFDO2FBQ0QsSUFBSSxDQUFDLFVBQUEsVUFBVTtZQUNaLElBQUksS0FBVyxDQUFDO1lBQ2hCLEVBQUUsQ0FBQSxDQUFDLG9CQUFTLENBQUMsQ0FBQSxDQUFDO2dCQUNWLEtBQUssR0FBUTtvQkFDVCxPQUFPLEVBQUUsVUFBVSxDQUFDLE9BQU87aUJBQzlCLENBQUM7Z0JBQ0YsS0FBSSxDQUFDLGlCQUFpQixDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ2xDLENBQUM7WUFDRCxJQUFJLENBQUMsQ0FBQztnQkFFRixJQUFJLE1BQU0sR0FBRyxJQUFJLFdBQVcsQ0FBQyxXQUFXLEVBQUUsQ0FBQztnQkFDM0MsTUFBTSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUM7cUJBQ3ZCLElBQUksQ0FBQyxVQUFBLFdBQVc7b0JBQ2IsSUFBSSxNQUFNLEdBQUcsRUFBRSxDQUFDLFlBQVksQ0FBQyxTQUFTLEVBQUUsQ0FBQztvQkFDekMsSUFBSSxJQUFJLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FB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LE9BQUEsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBZixDQUFlLENBQUMsQ0FBQztRQUVqRCxJQUFJLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxVQUFDLENBQUMsSUFBSyxPQUFBLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQWhCLENBQWdCLENBQUMsQ0FBQztRQUUxQyxJQUFJLENBQUMsRUFBRSxDQUFDLFVBQVUsRUFBRSxVQUFDLENBQUMsSUFBSyxPQUFBLE9BQU8sQ0FBQyxRQUFRLEVBQUUsRUFBbEIsQ0FBa0IsQ0FBQyxDQUFDO1FBRS9DLE1BQU0sQ0FBQyxPQUFPLENBQUM7SUFDbkIsQ0FBQztJQTdJUSxjQUFjO1FBTDFCLGdCQUFTLENBQUM7WUFDUCxRQUFRLEVBQUUsVUFBVTtZQUNwQixRQUFRLEVBQUUsTUFBTSxDQUFDLEVBQUU7WUFDbkIsV0FBVyxFQUFFLHdCQUF3QjtTQUN4QyxDQUFDOztPQUNXLGNBQWMsQ0ErSTFCO0lBQUQscUJBQUM7Q0FBQSxBQS9JRCxJQStJQztBQS9JWSx3Q0FBYyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgT25Jbml0IH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcblxuaW1wb3J0IHsgc2Vzc2lvbiwgU2Vzc2lvbiB9IGZyb20gXCJuYXRpdmVzY3JpcHQtYmFja2dyb3VuZC1odHRwXCI7XG5pbXBvcnQgKiBhcyBQaWNrZXIgZnJvbSBcIm5hdGl2ZXNjcmlwdC1pbWFnZXBpY2tlclwiO1xuaW1wb3J0ICogYXMgY2FtZXJhIGZyb20gXCJuYXRpdmVzY3JpcHQtY2FtZXJhXCI7XG5pbXBvcnQgeyBmaXJzdCB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQge1N1YmplY3R9IGZyb20gXCJyeGpzL1N1YmplY3RcIjtcbmltcG9ydCB7aXNBbmRyb2lkfSBmcm9tIFwidG5zLWNvcmUtbW9kdWxlcy9wbGF0Zm9ybVwiO1xuaW1wb3J0ICogYXMgZnMgZnJvbSBcImZpbGUtc3lzdGVtXCI7XG5pbXBvcnQgKiBhcyBpbWFnZVNvdXJjZSBmcm9tIFwiaW1hZ2Utc291cmNlXCI7XG5pbXBvcnQgeyBJbWFnZSB9IGZyb20gJ3VpL2ltYWdlJztcblxuQENvbXBvbmVudCh7XG4gICAgc2VsZWN0b3I6IFwibnMtaXRlbXNcIixcbiAgICBtb2R1bGVJZDogbW9kdWxlLmlkLFxuICAgIHRlbXBsYXRlVXJsOiBcIi4vaXRlbXMuY29tcG9uZW50Lmh0bWxcIixcbn0pXG5leHBvcnQgY2xhc3MgSXRlbXNDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xuICAgIHByaXZhdGUgcmVxdWVzdCA6IGFueTtcblxuICAgIHByaXZhdGUgaW1hZ2VOYW1lIDogc3RyaW5nO1xuICAgIHByaXZhdGUgVXBsb2FkU2Vzc2lvbjogU2Vzc2lvbjtcbiAgICBjb25zdHJ1Y3RvcihcblxuICAgICkge1xuICAgICAgICB0aGlzLlVwbG9hZFNlc3Npb24gPSBzZXNzaW9uKCdpbWFnZS11cGxvYWQnKTtcbiAgICB9XG5cbiAgICBuZ09uSW5pdCgpOiB2b2lkIHtcbiAgICB9XG5cbiAgICBjYW1lcmFPcGVuKCl7XG4gICAgICAgIGNhbWVyYS5yZXF1ZXN0UGVybWlzc2lvbnMoKTtcbiAgICAgICAgY2FtZXJhXG4gICAgICAgICAgICAudGFrZVBpY3R1cmUoe1xuICAgICAgICAgICAgICAgIHNhdmVUb0dhbGxlcnk6IHRydWUsXG4gICAgICAgICAgICAgICAgY2FtZXJhRmFjaW5nOiAnZnJvbnQnXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLnRoZW4oaW1hZ2VBc3NldCA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IGltYWdlIDogYW55O1xuICAgICAgICAgICAgICAgIGlmKGlzQW5kcm9pZCl7XG4gICAgICAgICAgICAgICAgICAgIGltYWdlID0gPGFueT57XG4gICAgICAgICAgICAgICAgICAgICAgICBmaWxlVXJpOiBpbWFnZUFzc2V0LmFuZHJvaWRcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGxvYWRJbWFnZVBpY2tlcihpbWFnZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuXG4gICAgICAgICAgICAgICAgICAgIGxldCBzb3VyY2UgPSBuZXcgaW1hZ2VTb3VyY2UuSW1hZ2VTb3VyY2UoKTtcbiAgICAgICAgICAgICAgICAgICAgc291cmNlLmZyb21Bc3NldChpbWFnZUFzc2V0KVxuICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oaW1hZ2VTb3VyY2UgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBmb2xkZXIgPSBmcy5rbm93bkZvbGRlcnMuZG9jdW1lbnRzKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBhdGggPSBmcy5wYXRoLmpvaW4oZm9sZGVyLnBhdGgsIFwiVGVtcFwiK0RhdGUubm93KCkrXCIuanBnXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBzYXZlZCA9IGltYWdlU291cmNlLnNhdmVUb0ZpbGUocGF0aCwgXCJwbmdcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coc2F2ZWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHNhdmVkKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy51cGxvYWRJbWFnZVBpY2tlcih7ZmlsZVVyaTogcGF0aH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24gKGVycikge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiRXJyb3IgLT4gXCIgKyBlcnIubWVzc2FnZSk7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwaWNrZXJPcGVuKCl7XG4gICAgICAgIGxldCBjb250ZXh0ID0gUGlja2VyLmNyZWF0ZSg8YW55PntcbiAgICAgICAgICAgIG1vZGU6IFwic2luZ2xlXCIsXG4gICAgICAgICAgICBtZGVpYVR5cGU6ICdpbWFnZSdcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuc3RhcnRTZWxlY3Rpb24oY29udGV4dCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGFydFNlbGVjdGlvbihjb250ZXh0OiBQaWNrZXIuSW1hZ2VQaWNrZXIpIHtcbiAgICAgICAgY29udGV4dFxuICAgICAgICAgICAgLmF1dGhvcml6ZSgpXG4gICAgICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQucHJlc2VudCgpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC50aGVuKChzZWxlY3Rpb246IEFycmF5PFBpY2tlci5TZWxlY3RlZEFzc2V0PikgPT4ge1xuICAgICAgICAgICAgICAgIGlmKGlzQW5kcm9pZCl7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmaXJzdChzZWxlY3Rpb24pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZpcnN0KHNlbGVjdGlvbikuZ2V0SW1hZ2UoKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAudGhlbigoaW1hZ2U6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmKGlzQW5kcm9pZCl7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudXBsb2FkSW1hZ2VQaWNrZXIoaW1hZ2UpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGZvbGRlciA9IGZzLmtub3duRm9sZGVycy5kb2N1bWVudHMoKTtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHBhdGggPSBmcy5wYXRoLmpvaW4oZm9sZGVyLnBhdGgsIFwiVGVtcFwiICsgRGF0ZS5ub3coKSArIFwiLnBuZ1wiKTtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHNhdmVkID0gaW1hZ2Uuc2F2ZVRvRmlsZShwYXRoLCBcInBuZ1wiKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coc2F2ZWQpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoc2F2ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vdXNlIG5ldyBpbWFnZSBwYXRoXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnVwbG9hZEltYWdlUGlja2VyKHtmaWxlVXJpOiBwYXRofSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSB1cGxvYWRJbWFnZVBpY2tlcihpbWFnZTogYW55KSB7XG5cbiAgICAgICAgdGhpcy51cGxvYWRNdWx0aXBhcnRJbWFnZVBpY2tlcihpbWFnZSlcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoe1xuICAgICAgICAgICAgICAgIG5leHQ6IChlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBVcGxvYWQ6ICR7KGUuY3VycmVudEJ5dGVzIC8gZS50b3RhbEJ5dGVzKSAqIDEwMH1gKVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgZXJyb3I6IChlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KGUpKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGNvbXBsZXRlOiAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiY29tcGxldGVcIik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgfVxuXG5cblxuXG5cbiAgICB1cGxvYWRNdWx0aXBhcnRJbWFnZVBpY2tlcihpbWFnZTogYW55KTogU3ViamVjdDxhbnk+IHtcblxuICAgICAgICBsZXQgIGZpbGVVcmkgPSBpbWFnZS5maWxlVXJpO1xuXG4gICAgICAgIGxldCByZXF1ZXN0ID0ge1xuICAgICAgICAgICAgdXJsOiBcImh0dHA6Ly8zNS4xNTguMTkzLjU1L2FwaS9GaWxlVXBsb2FkL0JvbFNlbGZpZVwiLFxuICAgICAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICAgICAgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW1cIixcbiAgICAgICAgICAgICAgICBcIkZpbGUtTmFtZVwiOiBmaWxlVXJpLFxuICAgICAgICAgICAgICAgICdBdXRob3JpemF0aW9uJzogXCJCZWFyZXIgZXlKMGVYQWlPaUpLVjFRaUxDSmhiR2NpT2lKSVV6STFOaUo5LmV5SnVZVzFsYVdRaU9pSTRNemxtTURnNE5DMWpNbUkzTFRRMVpHVXRPVGMxWXkwd09UWXdNVFk0TVdFMk0yRWlMQ0oxYm1seGRXVmZibUZ0WlNJNklqZ3pPV1l3T0RnMExXTXlZamN0TkRWa1pTMDVOelZqTFRBNU5qQXhOamd4WVRZellTSXNJbWgwZEhBNkx5OXpZMmhsYldGekxtMXBZM0p2YzI5bWRDNWpiMjB2WVdOalpYTnpZMjl1ZEhKdmJITmxjblpwWTJVdk1qQXhNQzh3Tnk5amJHRnBiWE12YVdSbGJuUnBkSGx3Y205MmFXUmxjaUk2SWtGVFVDNU9SVlFnU1dSbGJuUnBkSGtpTENKQmMzQk9aWFF1U1dSbGJuUnBkSGt1VTJWamRYSnBkSGxUZEdGdGNDSTZJbUZpTkdObU9XRTJMV1ZtWXpFdE5EWmhOaTA1TjJZeUxXTmxOemM1TmpreFpHTXhNQ0lzSWxWelpYSkpaQ0k2SWpnek9XWXdPRGcwTFdNeVlqY3RORFZrWlMwNU56VmpMVEE1TmpBeE5qZ3hZVFl6WVNJc0ltbHpjeUk2SW1oMGRIQTZMeTlzYjJOaGJHaHZjM1FpTENKaGRXUWlPaUkwTVRSbE1Ua3lOMkV6T0RnMFpqWTRZV0pqTnpsbU56STRNemd6TjJaa01TSXNJbVY0Y0NJNk1UVTJNemd4TURRNE5pd2libUptSWpveE5URXhPVGN3TkRnMmZRLktVZFlwZXJNb183OVFoUjNzVTNvZG10N0x6dUNqZFNNYTI1LUFVOVFMd0FcIixcbiAgICAgICAgICAgICAgICBcIlVzZXJJZFwiOiBcIjJhMjczNmNiLWU1ZTYtNDUxNS04YWQ3LTAyZWEwY2ZlZjA4YlwiXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZGVzY3JpcHRpb246IGBVcGxvYWRpbmcgYFxuICAgICAgICB9O1xuXG4gICAgICAgIGxldCBwYXJhbXMgPSBbeyBuYW1lOiBcIm5hbWVPZkZpbGVcIiwgZmlsZW5hbWU6IGZpbGVVcmksIG1pbWVUeXBlOiAnaW1hZ2UvSlBHJyB9XTtcbiAgICAgICAgY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkocGFyYW1zKSk7XG5cbiAgICAgICAgbGV0IHN1YmplY3QgPSBuZXcgU3ViamVjdDxhbnk+KCk7XG4gICAgICAgIGxldCB0YXNrID0gdGhpcy5VcGxvYWRTZXNzaW9uLm11bHRpcGFydFVwbG9hZChwYXJhbXMsIHJlcXVlc3QpO1xuICAgICAgICB0YXNrLm9uKCdwcm9ncmVzcycsIChlOiBhbnkpID0+IHN1YmplY3QubmV4dChlKSk7XG5cbiAgICAgICAgdGFzay5vbignZXJyb3InLCAoZSkgPT4gc3ViamVjdC5lcnJvcihlKSk7XG5cbiAgICAgICAgdGFzay5vbignY29tcGxldGUnLCAoZSkgPT4gc3ViamVjdC5jb21wbGV0ZSgpKTtcblxuICAgICAgICByZXR1cm4gc3ViamVjdDtcbiAgICB9XG5cbn1cbiJdfQ==