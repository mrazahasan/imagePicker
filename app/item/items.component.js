"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var nativescript_background_http_1 = require("nativescript-background-http");
var Picker = require("nativescript-imagepicker");
var camera = require("nativescript-camera");
var lodash_1 = require("lodash");
var Subject_1 = require("rxjs/Subject");
var platform_1 = require("tns-core-modules/platform");
var fs = require("file-system");
var imageSource = require("image-source");
var ItemsComponent = (function () {
    function ItemsComponent() {
        this.UploadSession = nativescript_background_http_1.session('image-upload');
    }
    ItemsComponent.prototype.ngOnInit = function () {
    };
    ItemsComponent.prototype.cameraOpen = function () {
        var _this = this;
        camera.requestPermissions();
        camera
            .takePicture({
            saveToGallery: true,
            cameraFacing: 'front'
        })
            .then(function (imageAsset) {
            var image;
            if (platform_1.isAndroid) {
                image = {
                    fileUri: imageAsset.android
                };
                _this.uploadImagePicker(image);
            }
            else {
                var source = new imageSource.ImageSource();
                source.fromAsset(imageAsset)
                    .then(function (imageSource) {
                    var folder = fs.knownFolders.documents();
                    var path = fs.path.join(folder.path, "Temp" + Date.now() + ".jpg");
                    var saved = imageSource.saveToFile(path, "png");
                    console.log(saved);
                    if (saved) {
                        _this.uploadImagePicker({ fileUri: path });
                    }
                });
            }
        })
            .catch(function (err) {
            console.log("Error -> " + err.message);
        });
    };
    ItemsComponent.prototype.pickerOpen = function () {
        var context = Picker.create({
            mode: "single",
            mdeiaType: 'image'
        });
        this.startSelection(context);
    };
    ItemsComponent.prototype.startSelection = function (context) {
        var _this = this;
        context
            .authorize()
            .then(function () {
            return context.present();
        })
            .then(function (selection) {
            if (platform_1.isAndroid) {
                return lodash_1.first(selection);
            }
            else {
                return lodash_1.first(selection).getImage();
            }
        })
            .then(function (image) {
            if (platform_1.isAndroid) {
                _this.uploadImagePicker(image);
            }
            else {
                var folder = fs.knownFolders.documents();
                var path = fs.path.join(folder.path, "Temp" + Date.now() + ".png");
                var saved = image.saveToFile(path, "png");
                console.log(saved);
                if (saved) {
                    //use new image path
                    _this.uploadImagePicker({ fileUri: path });
                }
            }
        })
            .catch(function (e) {
            console.error(e);
        });
    };
    ItemsComponent.prototype.uploadImagePicker = function (image) {
        this.uploadMultipartImagePicker(image)
            .subscribe({
            next: function (e) {
                console.log("Upload: " + (e.currentBytes / e.totalBytes) * 100);
            },
            error: function (e) {
                console.log(JSON.stringify(e));
            },
            complete: function () {
                console.log("complete");
            }
        });
    };
    ItemsComponent.prototype.uploadMultipartImagePicker = function (image) {
        var fileUri = image.fileUri;
        var request = {
            url: "http://35.158.193.55/api/FileUpload/BolSelfie",
            method: 'POST',
            headers: {
                "Content-Type": "application/octet-stream",
                "File-Name": fileUri,
                'Authorization': "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJuYW1laWQiOiI4MzlmMDg4NC1jMmI3LTQ1ZGUtOTc1Yy0wOTYwMTY4MWE2M2EiLCJ1bmlxdWVfbmFtZSI6IjgzOWYwODg0LWMyYjctNDVkZS05NzVjLTA5NjAxNjgxYTYzYSIsImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vYWNjZXNzY29udHJvbHNlcnZpY2UvMjAxMC8wNy9jbGFpbXMvaWRlbnRpdHlwcm92aWRlciI6IkFTUC5ORVQgSWRlbnRpdHkiLCJBc3BOZXQuSWRlbnRpdHkuU2VjdXJpdHlTdGFtcCI6ImFiNGNmOWE2LWVmYzEtNDZhNi05N2YyLWNlNzc5NjkxZGMxMCIsIlVzZXJJZCI6IjgzOWYwODg0LWMyYjctNDVkZS05NzVjLTA5NjAxNjgxYTYzYSIsImlzcyI6Imh0dHA6Ly9sb2NhbGhvc3QiLCJhdWQiOiI0MTRlMTkyN2EzODg0ZjY4YWJjNzlmNzI4MzgzN2ZkMSIsImV4cCI6MTU2MzgxMDQ4NiwibmJmIjoxNTExOTcwNDg2fQ.KUdYperMo_79QhR3sU3odmt7LzuCjdSMa25-AU9QLwA",
                "UserId": "2a2736cb-e5e6-4515-8ad7-02ea0cfef08b"
            },
            description: "Uploading "
        };
        var params = [{ name: "nameOfFile", filename: fileUri, mimeType: 'image/png' }];
        console.log(JSON.stringify(params));
        var subject = new Subject_1.Subject();
        var task = this.UploadSession.multipartUpload(params, request);
        task.on('progress', function (e) { return subject.next(e); });
        task.on('error', function (e) { return subject.error(e); });
        task.on('complete', function (e) { return subject.complete(); });
        return subject;
    };
    ItemsComponent = __decorate([
        core_1.Component({
            selector: "ns-items",
            moduleId: module.id,
            templateUrl: "./items.component.html",
        }),
        __metadata("design:paramtypes", [])
    ], ItemsComponent);
    return ItemsComponent;
}());
exports.ItemsComponent = ItemsComponent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaXRlbXMuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiaXRlbXMuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsc0NBQWtEO0FBRWxELDZFQUFnRTtBQUNoRSxpREFBbUQ7QUFDbkQsNENBQThDO0FBQzlDLGlDQUErQjtBQUMvQix3Q0FBcUM7QUFDckMsc0RBQW9EO0FBQ3BELGdDQUFrQztBQUNsQywwQ0FBNEM7QUFPNUM7SUFFSTtRQUdJLElBQUksQ0FBQyxhQUFhLEdBQUcsc0NBQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUNqRCxDQUFDO0lBRUQsaUNBQVEsR0FBUjtJQUNBLENBQUM7SUFFRCxtQ0FBVSxHQUFWO1FBQUEsaUJBaUNDO1FBaENHLE1BQU0sQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO1FBQzVCLE1BQU07YUFDRCxXQUFXLENBQUM7WUFDVCxhQUFhLEVBQUUsSUFBSTtZQUNuQixZQUFZLEVBQUUsT0FBTztTQUN4QixDQUFDO2FBQ0QsSUFBSSxDQUFDLFVBQUEsVUFBVTtZQUNaLElBQUksS0FBVyxDQUFDO1lBQ2hCLEVBQUUsQ0FBQSxDQUFDLG9CQUFTLENBQUMsQ0FBQSxDQUFDO2dCQUNWLEtBQUssR0FBUTtvQkFDVCxPQUFPLEVBQUUsVUFBVSxDQUFDLE9BQU87aUJBQzlCLENBQUM7Z0JBQ0YsS0FBSSxDQUFDLGlCQUFpQixDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ2xDLENBQUM7WUFDRCxJQUFJLENBQUMsQ0FBQztnQkFFRixJQUFJLE1BQU0sR0FBRyxJQUFJLFdBQVcsQ0FBQyxXQUFXLEVBQUUsQ0FBQztnQkFDM0MsTUFBTSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUM7cUJBQ3ZCLElBQUksQ0FBQyxVQUFBLFdBQVc7b0JBQ2IsSUFBSSxNQUFNLEdBQUcsRUFBRSxDQUFDLFlBQVksQ0FBQyxTQUFTLEVBQUUsQ0FBQztvQkFDekMsSUFBSSxJQUFJLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FB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LE9BQUEsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBZixDQUFlLENBQUMsQ0FBQztRQUVqRCxJQUFJLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxVQUFDLENBQUMsSUFBSyxPQUFBLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQWhCLENBQWdCLENBQUMsQ0FBQztRQUUxQyxJQUFJLENBQUMsRUFBRSxDQUFDLFVBQVUsRUFBRSxVQUFDLENBQUMsSUFBSyxPQUFBLE9BQU8sQ0FBQyxRQUFRLEVBQUUsRUFBbEIsQ0FBa0IsQ0FBQyxDQUFDO1FBRS9DLE1BQU0sQ0FBQyxPQUFPLENBQUM7SUFDbkIsQ0FBQztJQTFJUSxjQUFjO1FBTDFCLGdCQUFTLENBQUM7WUFDUCxRQUFRLEVBQUUsVUFBVTtZQUNwQixRQUFRLEVBQUUsTUFBTSxDQUFDLEVBQUU7WUFDbkIsV0FBVyxFQUFFLHdCQUF3QjtTQUN4QyxDQUFDOztPQUNXLGNBQWMsQ0E0STFCO0lBQUQscUJBQUM7Q0FBQSxBQTVJRCxJQTRJQztBQTVJWSx3Q0FBYyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgT25Jbml0IH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcblxuaW1wb3J0IHsgc2Vzc2lvbiwgU2Vzc2lvbiB9IGZyb20gXCJuYXRpdmVzY3JpcHQtYmFja2dyb3VuZC1odHRwXCI7XG5pbXBvcnQgKiBhcyBQaWNrZXIgZnJvbSBcIm5hdGl2ZXNjcmlwdC1pbWFnZXBpY2tlclwiO1xuaW1wb3J0ICogYXMgY2FtZXJhIGZyb20gXCJuYXRpdmVzY3JpcHQtY2FtZXJhXCI7XG5pbXBvcnQgeyBmaXJzdCB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQge1N1YmplY3R9IGZyb20gXCJyeGpzL1N1YmplY3RcIjtcbmltcG9ydCB7aXNBbmRyb2lkfSBmcm9tIFwidG5zLWNvcmUtbW9kdWxlcy9wbGF0Zm9ybVwiO1xuaW1wb3J0ICogYXMgZnMgZnJvbSBcImZpbGUtc3lzdGVtXCI7XG5pbXBvcnQgKiBhcyBpbWFnZVNvdXJjZSBmcm9tIFwiaW1hZ2Utc291cmNlXCI7XG5cbkBDb21wb25lbnQoe1xuICAgIHNlbGVjdG9yOiBcIm5zLWl0ZW1zXCIsXG4gICAgbW9kdWxlSWQ6IG1vZHVsZS5pZCxcbiAgICB0ZW1wbGF0ZVVybDogXCIuL2l0ZW1zLmNvbXBvbmVudC5odG1sXCIsXG59KVxuZXhwb3J0IGNsYXNzIEl0ZW1zQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcbiAgICBwcml2YXRlIFVwbG9hZFNlc3Npb246IFNlc3Npb247XG4gICAgY29uc3RydWN0b3IoXG5cbiAgICApIHtcbiAgICAgICAgdGhpcy5VcGxvYWRTZXNzaW9uID0gc2Vzc2lvbignaW1hZ2UtdXBsb2FkJyk7XG4gICAgfVxuXG4gICAgbmdPbkluaXQoKTogdm9pZCB7XG4gICAgfVxuXG4gICAgY2FtZXJhT3Blbigpe1xuICAgICAgICBjYW1lcmEucmVxdWVzdFBlcm1pc3Npb25zKCk7XG4gICAgICAgIGNhbWVyYVxuICAgICAgICAgICAgLnRha2VQaWN0dXJlKHtcbiAgICAgICAgICAgICAgICBzYXZlVG9HYWxsZXJ5OiB0cnVlLFxuICAgICAgICAgICAgICAgIGNhbWVyYUZhY2luZzogJ2Zyb250J1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC50aGVuKGltYWdlQXNzZXQgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBpbWFnZSA6IGFueTtcbiAgICAgICAgICAgICAgICBpZihpc0FuZHJvaWQpe1xuICAgICAgICAgICAgICAgICAgICBpbWFnZSA9IDxhbnk+e1xuICAgICAgICAgICAgICAgICAgICAgICAgZmlsZVVyaTogaW1hZ2VBc3NldC5hbmRyb2lkXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudXBsb2FkSW1hZ2VQaWNrZXIoaW1hZ2UpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcblxuICAgICAgICAgICAgICAgICAgICBsZXQgc291cmNlID0gbmV3IGltYWdlU291cmNlLkltYWdlU291cmNlKCk7XG4gICAgICAgICAgICAgICAgICAgIHNvdXJjZS5mcm9tQXNzZXQoaW1hZ2VBc3NldClcbiAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKGltYWdlU291cmNlID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgZm9sZGVyID0gZnMua25vd25Gb2xkZXJzLmRvY3VtZW50cygpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBwYXRoID0gZnMucGF0aC5qb2luKGZvbGRlci5wYXRoLCBcIlRlbXBcIitEYXRlLm5vdygpK1wiLmpwZ1wiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgc2F2ZWQgPSBpbWFnZVNvdXJjZS5zYXZlVG9GaWxlKHBhdGgsIFwicG5nXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHNhdmVkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihzYXZlZCl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudXBsb2FkSW1hZ2VQaWNrZXIoe2ZpbGVVcmk6IHBhdGh9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIkVycm9yIC0+IFwiICsgZXJyLm1lc3NhZ2UpO1xuICAgICAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcGlja2VyT3Blbigpe1xuICAgICAgICBsZXQgY29udGV4dCA9IFBpY2tlci5jcmVhdGUoPGFueT57XG4gICAgICAgICAgICBtb2RlOiBcInNpbmdsZVwiLFxuICAgICAgICAgICAgbWRlaWFUeXBlOiAnaW1hZ2UnXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnN0YXJ0U2VsZWN0aW9uKGNvbnRleHQpO1xuICAgIH1cblxuICAgIHByaXZhdGUgc3RhcnRTZWxlY3Rpb24oY29udGV4dDogUGlja2VyLkltYWdlUGlja2VyKSB7XG4gICAgICAgIGNvbnRleHRcbiAgICAgICAgICAgIC5hdXRob3JpemUoKVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBjb250ZXh0LnByZXNlbnQoKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAudGhlbigoc2VsZWN0aW9uOiBBcnJheTxQaWNrZXIuU2VsZWN0ZWRBc3NldD4pID0+IHtcbiAgICAgICAgICAgICAgICBpZihpc0FuZHJvaWQpe1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmlyc3Qoc2VsZWN0aW9uKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmaXJzdChzZWxlY3Rpb24pLmdldEltYWdlKCk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLnRoZW4oKGltYWdlOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICBpZihpc0FuZHJvaWQpe1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnVwbG9hZEltYWdlUGlja2VyKGltYWdlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBmb2xkZXIgPSBmcy5rbm93bkZvbGRlcnMuZG9jdW1lbnRzKCk7XG4gICAgICAgICAgICAgICAgICAgIGxldCBwYXRoID0gZnMucGF0aC5qb2luKGZvbGRlci5wYXRoLCBcIlRlbXBcIiArIERhdGUubm93KCkgKyBcIi5wbmdcIik7XG4gICAgICAgICAgICAgICAgICAgIGxldCBzYXZlZCA9IGltYWdlLnNhdmVUb0ZpbGUocGF0aCwgXCJwbmdcIik7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHNhdmVkKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNhdmVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvL3VzZSBuZXcgaW1hZ2UgcGF0aFxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy51cGxvYWRJbWFnZVBpY2tlcih7ZmlsZVVyaTogcGF0aH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5jYXRjaChmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZSk7XG4gICAgICAgICAgICB9KTtcblxuICAgIH1cblxuICAgIHByaXZhdGUgdXBsb2FkSW1hZ2VQaWNrZXIoaW1hZ2U6IGFueSkge1xuXG4gICAgICAgIHRoaXMudXBsb2FkTXVsdGlwYXJ0SW1hZ2VQaWNrZXIoaW1hZ2UpXG4gICAgICAgICAgICAuc3Vic2NyaWJlKHtcbiAgICAgICAgICAgICAgICBuZXh0OiAoZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgVXBsb2FkOiAkeyhlLmN1cnJlbnRCeXRlcyAvIGUudG90YWxCeXRlcykgKiAxMDB9YClcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGVycm9yOiAoZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShlKSk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBjb21wbGV0ZTogKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcImNvbXBsZXRlXCIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuXG5cblxuXG4gICAgdXBsb2FkTXVsdGlwYXJ0SW1hZ2VQaWNrZXIoaW1hZ2U6IGFueSk6IFN1YmplY3Q8YW55PiB7XG5cbiAgICAgICAgbGV0ICBmaWxlVXJpID0gaW1hZ2UuZmlsZVVyaTtcblxuICAgICAgICBsZXQgcmVxdWVzdCA9IHtcbiAgICAgICAgICAgIHVybDogXCJodHRwOi8vMzUuMTU4LjE5My41NS9hcGkvRmlsZVVwbG9hZC9Cb2xTZWxmaWVcIixcbiAgICAgICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICAgICAgIFwiQ29udGVudC1UeXBlXCI6IFwiYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtXCIsXG4gICAgICAgICAgICAgICAgXCJGaWxlLU5hbWVcIjogZmlsZVVyaSxcbiAgICAgICAgICAgICAgICAnQXV0aG9yaXphdGlvbic6IFwiQmVhcmVyIGV5SjBlWEFpT2lKS1YxUWlMQ0poYkdjaU9pSklVekkxTmlKOS5leUp1WVcxbGFXUWlPaUk0TXpsbU1EZzROQzFqTW1JM0xUUTFaR1V0T1RjMVl5MHdPVFl3TVRZNE1XRTJNMkVpTENKMWJtbHhkV1ZmYm1GdFpTSTZJamd6T1dZd09EZzBMV015WWpjdE5EVmtaUzA1TnpWakxUQTVOakF4TmpneFlUWXpZU0lzSW1oMGRIQTZMeTl6WTJobGJXRnpMbTFwWTNKdmMyOW1kQzVqYjIwdllXTmpaWE56WTI5dWRISnZiSE5sY25acFkyVXZNakF4TUM4d055OWpiR0ZwYlhNdmFXUmxiblJwZEhsd2NtOTJhV1JsY2lJNklrRlRVQzVPUlZRZ1NXUmxiblJwZEhraUxDSkJjM0JPWlhRdVNXUmxiblJwZEhrdVUyVmpkWEpwZEhsVGRHRnRjQ0k2SW1GaU5HTm1PV0UyTFdWbVl6RXRORFpoTmkwNU4yWXlMV05sTnpjNU5qa3haR014TUNJc0lsVnpaWEpKWkNJNklqZ3pPV1l3T0RnMExXTXlZamN0TkRWa1pTMDVOelZqTFRBNU5qQXhOamd4WVRZellTSXNJbWx6Y3lJNkltaDBkSEE2THk5c2IyTmhiR2h2YzNRaUxDSmhkV1FpT2lJME1UUmxNVGt5TjJFek9EZzBaalk0WVdKak56bG1Oekk0TXpnek4yWmtNU0lzSW1WNGNDSTZNVFUyTXpneE1EUTROaXdpYm1KbUlqb3hOVEV4T1Rjd05EZzJmUS5LVWRZcGVyTW9fNzlRaFIzc1Uzb2RtdDdMenVDamRTTWEyNS1BVTlRTHdBXCIsXG4gICAgICAgICAgICAgICAgXCJVc2VySWRcIjogXCIyYTI3MzZjYi1lNWU2LTQ1MTUtOGFkNy0wMmVhMGNmZWYwOGJcIlxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBgVXBsb2FkaW5nIGBcbiAgICAgICAgfTtcblxuICAgICAgICBsZXQgcGFyYW1zID0gW3sgbmFtZTogXCJuYW1lT2ZGaWxlXCIsIGZpbGVuYW1lOiBmaWxlVXJpLCBtaW1lVHlwZTogJ2ltYWdlL3BuZycgfV07XG4gICAgICAgIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KHBhcmFtcykpO1xuXG4gICAgICAgIGxldCBzdWJqZWN0ID0gbmV3IFN1YmplY3Q8YW55PigpO1xuICAgICAgICBsZXQgdGFzayA9IHRoaXMuVXBsb2FkU2Vzc2lvbi5tdWx0aXBhcnRVcGxvYWQocGFyYW1zLCByZXF1ZXN0KTtcbiAgICAgICAgdGFzay5vbigncHJvZ3Jlc3MnLCAoZTogYW55KSA9PiBzdWJqZWN0Lm5leHQoZSkpO1xuXG4gICAgICAgIHRhc2sub24oJ2Vycm9yJywgKGUpID0+IHN1YmplY3QuZXJyb3IoZSkpO1xuXG4gICAgICAgIHRhc2sub24oJ2NvbXBsZXRlJywgKGUpID0+IHN1YmplY3QuY29tcGxldGUoKSk7XG5cbiAgICAgICAgcmV0dXJuIHN1YmplY3Q7XG4gICAgfVxuXG59XG4iXX0=